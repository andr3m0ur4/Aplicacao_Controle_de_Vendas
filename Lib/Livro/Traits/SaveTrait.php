<?php

namespace Livro\Traits;

use Livro\Database\Transaction;
use Livro\Widgets\Dialog\Message;
use Exception;

trait SaveTrait
{
    /**
     * Salva os dados do formulário
     */
    function onSave ( )
    {
        try {
            Transaction::open ( $this -> connection );  // abre transação
            
            $class = $this -> activeRecord;             // classe de Active Record
            $dados = $this -> form -> getData ( );      // lê dados do form
            
            $object = new $class;                       // instancia objeto
            $object -> fromArray ( ( array ) $dados );  // carrega os dados
            $object -> store ( );                       // armazena o objeto
            
            $dados -> id = $object -> id;
            $this -> form -> setData ( $dados );
            
            Transaction::close ( );                     // finaliza a transação
            new Message ( 'info', 'Dados armazenados com sucesso' );
            
        } catch (Exception $e) {
            new Message ( 'error', $e -> getMessage ( ) );
        }
    }
}
